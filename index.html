<!DOCTYPE html>
<html>
<head>
  <title>Printable Shelf Talker Cards</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    @page {
      size: 8.5in 11in;
      margin: 0;
    }
    @media print {
      .controls, .form, #barcode-scanner {
        display: none !important;
      }
      body {
        margin: 0;
        padding: 0;
      }
    }
    body {
      font-family: Georgia, serif;
      margin: 0;
      padding: 0;
    }
    .sheet {
      display: flex;
      flex-direction: column;
      gap: 0;
      height: auto;
      align-items: center;
      page-break-after: always;
    }
    .card {
      width: 15cm;
      height: 5.5cm;
      border: 1px solid #aaa;
      padding: 16px 2.5cm 16px 1.8cm;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      margin-bottom: 0;
      position: relative;
    }
    .title {
      font-family: Georgia, serif;
      font-size: 28px;
      font-weight: normal;
      margin: 0;
    }
    .author {
      font-family: Arial, sans-serif;
      font-size: 16px;
      font-weight: bold;
      margin: 4px 0 12px 0;
    }
    .summary {
      font-family: Georgia, serif;
      font-size: 13px;
      font-weight: normal;
      line-height: 1.4;
    }
    .footer-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      padding-left: 0;
      padding-right: 1cm;
      width: 100%;
    }
    .footer-line-alt {
      border-top: 2px solid black;
      width: 100%;
      margin-right: 10px;
    }
    .footer-text {
      font-family: Arial, sans-serif;
      font-size: 13px;
      font-weight: bold;
      white-space: nowrap;
    }
    .controls {
      padding: 10px;
      position: sticky;
      top: 0;
      background: white;
      z-index: 999;
      display: flex;
      gap: 10px;
    }
    .form {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-width: 400px;
      margin: 10px;
    }
    .form input, .form textarea {
      padding: 6px;
      font-size: 14px;
      width: 100%;
    }
    #barcode-scanner {
      width: 100%;
      max-width: 400px;
      margin: 10px auto;
      display: none;
    }
  </style>
</head>
<body>
  <div class="controls">
    <button onclick="printCards()">üñ®Ô∏è Print Cards</button>
    <button onclick="clearCards()">üóëÔ∏è Clear Queue</button>
    <button onclick="addCardFromButton()">‚ûï Add to Print Queue</button>
    <button onclick="toggleScanner()">üì∑ Scan Barcode</button>
  </div>

  <form class="form" id="cardForm" onsubmit="addCard(event)">
    <input type="text" id="isbn" placeholder="ISBN Number" onblur="handleISBN()" onkeydown="if(event.key==='Enter'){ event.preventDefault(); handleISBN(); }" />
    <input type="text" id="title" placeholder="Book Title" required />
    <input type="text" id="author" placeholder="Author Name" required />
    <button type="button" onclick="generateSummary()">üîÑ Regenerate Summary</button>
    <textarea id="summary" placeholder="Summary (max 260 characters)" maxlength="260" rows="6" required></textarea>
    <button type="button" onclick="addCardFromButton()">‚ûï Add to Print Queue</button>
  </form>

  <div id="barcode-scanner"></div>
  <div id="container"></div>

  <script>
    const cardQueue = [];
    let scanner;

    function toggleScanner() {
      const container = document.getElementById("barcode-scanner");
      if (container.style.display === "none") {
        container.style.display = "block";
        startScanner();
      } else {
        container.style.display = "none";
        stopScanner();
      }
    }

    function startScanner() {
      if (!scanner) {
        scanner = new Html5Qrcode("barcode-scanner");
      }
      scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
        if (/^\d{10,13}$/.test(decodedText)) {
          document.getElementById("isbn").value = decodedText;
          handleISBN();
          toggleScanner();
        }
      }, (error) => {
        console.warn(error);
      });
    }

    function stopScanner() {
      if (scanner) {
        scanner.stop().then(() => {
          document.getElementById("barcode-scanner").style.display = "none";
        }).catch(console.error);
      }
    }

    function toTitleCase(str) {
      return str.toLowerCase().replace(/\b(\w)/g, s => s.toUpperCase());
    }

    async function handleISBN() {
      const isbn = document.getElementById("isbn").value.trim();
      if (!isbn) return;
      const res = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&format=json&jscmd=data`);
      const data = await res.json();
      const book = data[`ISBN:${isbn}`];
      if (book) {
        const title = book.title || "";
        const author = book.authors?.[0]?.name || "";
        if (title && author) {
          document.getElementById("title").value = title;
          document.getElementById("author").value = author;
        }
      }
    }

    async function generateSummary() {
      const title = document.getElementById("title").value.trim();
      const author = document.getElementById("author").value.trim();
      if (!title || !author) {
        alert("Please enter or resolve title and author first.");
        return;
      }

      const prompt = `Write a professional literary summary in under 260 characters, including spaces, for a bookstore display card. Do not include the title '${title}' or the author '${author}' in the summary. The tone should be formal, like something from The New York Times. Start directly with the summary.`;

      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer YOUR_OPENAI_API_KEY"
        },
        body: JSON.stringify({
          model: "gpt-4",
          messages: [{ role: "user", content: prompt }],
          temperature: 0.7
        })
      });

      const data = await response.json();
      const summary = data.choices?.[0]?.message?.content?.trim();
      if (summary) {
        document.getElementById("summary").value = summary;
      } else {
        alert("Failed to generate summary.");
      }
    }

    function renderCards() {
      const container = document.getElementById("container");
      container.innerHTML = "";
      for (let i = 0; i < cardQueue.length; i += 5) {
        const sheet = document.createElement("div");
        sheet.className = "sheet";
        for (let j = i; j < i + 5 && j < cardQueue.length; j++) {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div>
              <div class="title">${cardQueue[j].title}</div>
              <div class="author">${cardQueue[j].author}</div>
              <div class="summary">${cardQueue[j].summary}</div>
            </div>
            <div class="footer-container">
              <div class="footer-line-alt"></div>
              <div class="footer-text">B&amp;N Ocala</div>
            </div>
          `;
          sheet.appendChild(card);
        }
        container.appendChild(sheet);
      }
    }

    function printCards() {
      window.print();
    }

    function clearCards() {
      cardQueue.length = 0;
      renderCards();
    }

    function addCardFromButton() {
      document.getElementById("cardForm").dispatchEvent(new Event("submit", { cancelable: true, bubbles: true }));
    }

    function addCard(event) {
      event.preventDefault();
      let title = document.getElementById("title").value.trim();
      let author = document.getElementById("author").value.trim();
      const summary = document.getElementById("summary").value.trim();
      if (title && author && summary) {
        title = toTitleCase(title);
        author = toTitleCase(author);
        cardQueue.push({ title, author, summary });
        document.getElementById("title").value = "";
        document.getElementById("author").value = "";
        document.getElementById("summary").value = "";
        document.getElementById("isbn").value = "";
        renderCards();
      }
    }

    renderCards();
  </script>
</body>
</html>
